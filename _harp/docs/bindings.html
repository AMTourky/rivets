<!DOCTYPE html>

<html>
<head>
  <title>bindings.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="adapters.html">
                adapters.coffee
              </a>
            
              
              <a class="source" href="binders.html">
                binders.coffee
              </a>
            
              
              <a class="source" href="bindings.html">
                bindings.coffee
              </a>
            
              
              <a class="source" href="export.html">
                export.coffee
              </a>
            
              
              <a class="source" href="keypath_observer.html">
                keypath_observer.coffee
              </a>
            
              
              <a class="source" href="parsers.html">
                parsers.coffee
              </a>
            
              
              <a class="source" href="rivets.html">
                rivets.coffee
              </a>
            
              
              <a class="source" href="util.html">
                util.coffee
              </a>
            
              
              <a class="source" href="view.html">
                view.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>bindings.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2>Rivets.Binding</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>A single binding between a model attribute and a DOM element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Rivets</span>.<span class="title">Binding</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>All information about the binding is passed into the constructor; the
containing view, the DOM node, the type of binding, the model object and the
keypath at which to listen for changes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: (<span class="property">@view</span>, <span class="property">@el</span>, <span class="property">@type</span>, <span class="property">@keypath</span>, <span class="property">@options</span> = {}) -&gt;
    <span class="property">@formatters</span> = <span class="property">@options</span>.formatters || []
    <span class="property">@dependencies</span> = []
    <span class="property">@setBinder</span>()
    <span class="property">@setObserver</span>()

  setBinder: =&gt;
    <span class="keyword">unless</span> <span class="property">@binder</span> = <span class="property">@view</span>.binders[<span class="property">@type</span>]
      <span class="keyword">for</span> identifier, value <span class="keyword">of</span> <span class="property">@view</span>.binders
        <span class="keyword">if</span> identifier <span class="keyword">isnt</span> <span class="string">'*'</span> <span class="keyword">and</span> identifier.indexOf(<span class="string">'*'</span>) <span class="keyword">isnt</span> -<span class="number">1</span>
          regexp = <span class="keyword">new</span> RegExp <span class="string">"^<span class="subst">#{identifier.replace('*', '.+')}</span>$"</span>
          <span class="keyword">if</span> regexp.test <span class="property">@type</span>
            <span class="property">@binder</span> = value
            <span class="property">@args</span> = <span class="keyword">new</span> RegExp(<span class="string">"^<span class="subst">#{identifier.replace('*', '(.+)')}</span>$"</span>).exec <span class="property">@type</span>
            <span class="property">@args</span>.shift()

    <span class="property">@binder</span> <span class="keyword">or</span>= <span class="property">@view</span>.binders[<span class="string">'*'</span>]
    <span class="property">@binder</span> = {routine: <span class="property">@binder</span>} <span class="keyword">if</span> <span class="property">@binder</span> <span class="keyword">instanceof</span> Function

  setObserver: =&gt;
    <span class="property">@observer</span> = <span class="keyword">new</span> KeypathObserver <span class="property">@view</span>, <span class="property">@view</span>.models, <span class="property">@keypath</span>, (obs) =&gt;
      <span class="property">@unbind</span> <span class="literal">true</span> <span class="keyword">if</span> <span class="property">@key</span>
      <span class="property">@model</span> = obs.target
      <span class="property">@bind</span> <span class="literal">true</span> <span class="keyword">if</span> <span class="property">@key</span>
      <span class="property">@sync</span>()

    <span class="property">@key</span> = <span class="property">@observer</span>.key
    <span class="property">@model</span> = <span class="property">@observer</span>.target</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Applies all the current formatters to the supplied value and returns the
formatted value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  formattedValue: (value) =&gt;
    <span class="keyword">for</span> formatter <span class="keyword">in</span> <span class="property">@formatters</span>
      args = formatter.split <span class="regexp">/\s+/</span>
      id = args.shift()
      formatter = <span class="property">@view</span>.formatters[id]

      <span class="keyword">if</span> formatter?.read <span class="keyword">instanceof</span> Function
        value = formatter.read value, args...
      <span class="keyword">else</span> <span class="keyword">if</span> formatter <span class="keyword">instanceof</span> Function
        value = formatter value, args...

    value</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Returns an event handler for the binding around the supplied function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  eventHandler: (fn) =&gt;
    handler = (binding = @).view.config.handler
    (ev) -&gt; handler.call fn, @, ev, binding</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Sets the value for the binding. This Basically just runs the binding routine
with the suplied value formatted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set: (value) =&gt;
    value = <span class="keyword">if</span> value <span class="keyword">instanceof</span> Function <span class="keyword">and</span> !<span class="property">@binder</span>.<span class="reserved">function</span>
      <span class="property">@formattedValue</span> value.call <span class="property">@model</span>
    <span class="keyword">else</span>
      <span class="property">@formattedValue</span> value

    <span class="property">@binder</span>.routine?.call @, <span class="property">@el</span>, value</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Syncs up the view binding with the model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sync: =&gt;
    <span class="property">@set</span> <span class="keyword">if</span> <span class="property">@key</span>
      <span class="property">@view</span>.adapters[<span class="property">@key</span>.interface].read <span class="property">@model</span>, <span class="property">@key</span>.path
    <span class="keyword">else</span>
      <span class="property">@model</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Publishes the value currently set on the input element back to the model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  publish: =&gt;
    value = Rivets.Util.getInputValue <span class="property">@el</span>

    <span class="keyword">for</span> formatter <span class="keyword">in</span> <span class="property">@formatters</span>.slice(<span class="number">0</span>).reverse()
      args = formatter.split <span class="regexp">/\s+/</span>
      id = args.shift()

      <span class="keyword">if</span> <span class="property">@view</span>.formatters[id]?.publish
        value = <span class="property">@view</span>.formatters[id].publish value, args...

    <span class="property">@view</span>.adapters[<span class="property">@key</span>.interface].publish <span class="property">@model</span>, <span class="property">@key</span>.path, value</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Subscribes to the model for changes at the specified keypath. Bi-directional
routines will also listen for changes on the element to propagate them back
to the model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  bind: (silent = <span class="literal">false</span>) =&gt;
    <span class="property">@binder</span>.bind?.call @, <span class="property">@el</span> <span class="keyword">unless</span> silent
    <span class="property">@view</span>.adapters[<span class="property">@key</span>.interface].subscribe(<span class="property">@model</span>, <span class="property">@key</span>.path, <span class="property">@sync</span>) <span class="keyword">if</span> <span class="property">@key</span>
    <span class="property">@sync</span>() <span class="keyword">if</span> <span class="property">@view</span>.config.preloadData <span class="keyword">unless</span> silent

    <span class="keyword">if</span> <span class="property">@options</span>.dependencies?.length
      <span class="keyword">for</span> dependency <span class="keyword">in</span> <span class="property">@options</span>.dependencies
        observer = <span class="keyword">new</span> KeypathObserver <span class="property">@view</span>, <span class="property">@model</span>, dependency, (obs, prev) =&gt;
          key = obs.key
          <span class="property">@view</span>.adapters[key.interface].unsubscribe prev, key.path, <span class="property">@sync</span>
          <span class="property">@view</span>.adapters[key.interface].subscribe obs.target, key.path, <span class="property">@sync</span>
          <span class="property">@sync</span>()

        key = observer.key
        <span class="property">@view</span>.adapters[key.interface].subscribe observer.target, key.path, <span class="property">@sync</span>
        <span class="property">@dependencies</span>.push observer</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Unsubscribes from the model and the element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  unbind: (silent = <span class="literal">false</span>) =&gt;
    <span class="property">@binder</span>.unbind?.call @, <span class="property">@el</span> <span class="keyword">unless</span> silent
    <span class="property">@view</span>.adapters[<span class="property">@key</span>.interface].unsubscribe(<span class="property">@model</span>, <span class="property">@key</span>.path, <span class="property">@sync</span>) <span class="keyword">if</span> <span class="property">@key</span>

    <span class="keyword">if</span> <span class="property">@dependencies</span>.length
      <span class="keyword">for</span> obs <span class="keyword">in</span> <span class="property">@dependencies</span>
        key = obs.key
        <span class="property">@view</span>.adapters[key.interface].unsubscribe obs.target, key.path, <span class="property">@sync</span>

      <span class="property">@dependencies</span> = []</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Updates the binding&#39;s model from what is currently set on the view. Unbinds
the old model first and then re-binds with the new model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  update: (models = {}) =&gt;
    <span class="property">@binder</span>.update?.call @, models</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2>Rivets.ComponentBinding</h2>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>A component view encapsulated as a binding within it&#39;s parent view.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Rivets</span>.<span class="title">ComponentBinding</span> <span class="keyword">extends</span> <span class="title">Rivets</span>.<span class="title">Binding</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Initializes a component binding for the specified view. The raw component
element is passed in along with the component type. Attributes and scope
inflections are determined based on the components defined attributes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: (<span class="property">@view</span>, <span class="property">@el</span>, <span class="property">@type</span>) -&gt;
    <span class="property">@component</span> = Rivets.components[<span class="property">@type</span>]
    <span class="property">@attributes</span> = {}
    <span class="property">@inflections</span> = {}

    <span class="keyword">for</span> attribute <span class="keyword">in</span> <span class="property">@el</span>.attributes <span class="keyword">or</span> []
      <span class="keyword">if</span> attribute.name <span class="keyword">in</span> <span class="property">@component</span>.attributes
        <span class="property">@attributes</span>[attribute.name] = attribute.value
      <span class="keyword">else</span>
        <span class="property">@inflections</span>[attribute.name] = attribute.value</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Intercepts <code>Rivets.Binding::sync</code> since component bindings are not bound to
a particular model to update it&#39;s value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sync: -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Returns an object map using the component&#39;s scope inflections.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  locals: (models = <span class="property">@view</span>.models) =&gt;
    result = {}

    <span class="keyword">for</span> key, inverse <span class="keyword">of</span> <span class="property">@inflections</span>
      result[key] = (result[key] <span class="keyword">or</span> models)[path] <span class="keyword">for</span> path <span class="keyword">in</span> inverse.split <span class="string">'.'</span>

    result[key] ?= model <span class="keyword">for</span> key, model <span class="keyword">of</span> models
    result</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Intercepts <code>Rivets.Binding::update</code> to be called on <code>@componentView</code> with a
localized map of the models.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  update: (models) =&gt;
    <span class="property">@componentView</span>?.update <span class="property">@locals</span> models</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Intercepts <code>Rivets.Binding::bind</code> to build <code>@componentView</code> with a localized
map of models from the root view. Bind <code>@componentView</code> on subsequent calls.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  bind: =&gt;
    <span class="keyword">if</span> <span class="property">@componentView</span>?
      <span class="property">@componentView</span>?.bind()
    <span class="keyword">else</span>
      el = <span class="property">@component</span>.build.call <span class="property">@attributes</span>
      (<span class="property">@componentView</span> = <span class="keyword">new</span> Rivets.View(el, <span class="property">@locals</span>(), <span class="property">@view</span>.options)).bind()
      <span class="property">@el</span>.parentNode.replaceChild el, <span class="property">@el</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Intercept <code>Rivets.Binding::unbind</code> to be called on <code>@componentView</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  unbind: =&gt;
    <span class="property">@componentView</span>?.unbind()</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2>Rivets.TextBinding</h2>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>A text node binding, defined internally to deal with text and element node
differences while avoiding it being overwritten.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">Rivets</span>.<span class="title">TextBinding</span> <span class="keyword">extends</span> <span class="title">Rivets</span>.<span class="title">Binding</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Initializes a text binding for the specified view and text node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: (<span class="property">@view</span>, <span class="property">@el</span>, <span class="property">@type</span>, <span class="property">@keypath</span>, <span class="property">@options</span> = {}) -&gt;
    <span class="property">@formatters</span> = <span class="property">@options</span>.formatters || []
    <span class="property">@dependencies</span> = []
    <span class="property">@setObserver</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>A standard routine binder used for text node bindings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  binder:
    routine: (node, value) -&gt;
      node.data = value ? <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Wrap the call to <code>sync</code> in fat-arrow to avoid function context issues.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sync: =&gt;
    <span class="keyword">super</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
